<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Al Wassiya - Votre Testament Islamique Simplifié</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        /* [TOUT LE CSS EXISTANT EST CONSERVÉ ICI] */
        :root {
            --primary: #C9B178;
            --primary-dark: #A89262;
            --secondary: #2D4C68;
            --accent: #3A5F7E;
            --light: #F8F5EE;
            --dark: #1E1E24;
            --success: #4CAF50;
            --error: #E74C3C;
            --radius: 16px;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #F8F5EE 0%, #E6E2D6 100%);
            color: var(--dark);
            line-height: 1.7;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* [TOUT LE RESTE DU CSS EXISTANT] */
        /* ... */
    </style>
</head>
<body>
    <a href="#main-content" class="skip-to-content">Aller au contenu principal</a>
    
    <div class="islamic-pattern"></div>
    
    <div class="container">
        <div class="header">
            <div class="logo">Al Wassiya</div>
            <div class="subtitle">Votre Testament Islamique Simplifié</div>
            <div class="bismillah">بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيم</div>
            <p>Créez facilement un testament islamique respectant le Coran et la Sunna</p>
        </div>

        <div class="step-dots" id="stepDots">
            <div class="step-dot active" data-step="1"></div>
            <div class="step-dot" data-step="2"></div>
            <div class="step-dot" data-step="3"></div>
            <div class="step-dot" data-step="4"></div>
            <div class="step-dot" data-step="5"></div>
        </div>

        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="step-indicator" id="stepIndicator">
                Étape 1 sur 5 : Informations personnelles et volontés générales
            </div>
        </div>

        <div class="quranic-verse">
            <div class="arabic-verse">كُتِبَ عَلَيْكُمْ إِذَا حَضَرَ أَحَدَكُمُ الْمَوْتُ إِن تَرَكَ خَيْرًا الْوَصِيَّةُ لِلْوَالِدَيْنِ وَالْأَقْرَبِينَ بِالْمَعْرُوفِ ۖ حَقًّا عَلَى الْمُتَّقِينَ</div>
            <div>"Il vous est prescrit, quand la mort se présente à l'un de vous, s'il laisse des biens, de faire un testament en faveur de ses père et mère et de ses proches, selon les convenances. C'est un devoir pour les pieux." - Sourate Al-Baqara, verset 180</div>
            <div class="translation-note">(c'est une traduction rapprochée)</div>
        </div>

        <main id="main-content">
            <!-- [TOUT LE FORMULAIRE EXISTANT EST CONSERVÉ ICI] -->
            <form id="testamentForm" novalidate>
                <!-- Étape 1: Informations personnelles -->
                <div id="step1" class="form-step">
                    <!-- ... -->
                </div>

                <!-- Étape 2: Famille et proches -->
                <div id="step2" class="form-step" style="display: none;">
                    <!-- ... -->
                </div>

                <!-- Étape 3: Biens matériels et financiers -->
                <div id="step3" class="form-step" style="display: none;">
                    <!-- ... -->
                </div>

                <!-- Étape 4: Dettes et devoirs religieux -->
                <div id="step4" class="form-step" style="display: none;">
                    <!-- ... -->
                </div>

                <!-- Étape 5: Données numériques et réseaux sociaux -->
                <div id="step5" class="form-step" style="display: none;">
                    <!-- ... -->
                </div>

                <div class="actions">
                    <button type="button" class="btn btn-secondary" onclick="sauvegarderBrouillon()">
                        <i class="fas fa-save"></i> Sauvegarder le brouillon
                    </button>
                    <button type="button" class="btn btn-primary" id="generatePdfBtn">
                        <i class="fas fa-file-pdf"></i> Générer le PDF
                    </button>
                    <button type="button" class="btn btn-secondary" id="prevStepBtn" style="display: none;" onclick="prevStep()">
                        <i class="fas fa-arrow-left"></i> Étape précédente
                    </button>
                    <button type="button" class="btn btn-primary" id="nextStepBtn" onclick="nextStep()">
                        Continuer vers la famille <i class="fas fa-arrow-right"></i>
                    </button>
                </div>

                <div class="share-section">
                    <div class="share-title">Partager cette application</div>
                    <div class="share-buttons">
                        <div class="share-btn whatsapp" onclick="partagerWhatsApp()">
                            <i class="fab fa-whatsapp"></i>
                        </div>
                        <div class="share-btn facebook" onclick="partagerFacebook()">
                            <i class="fab fa-facebook-f"></i>
                        </div>
                        <div class="share-btn twitter" onclick="partagerTwitter()">
                            <i class="fab fa-twitter"></i>
                        </div>
                        <div class="share-btn email" onclick="partagerEmail()">
                            <i class="fas fa-envelope"></i>
                        </div>
                    </div>
                </div>
            </form>
        </main>

        <div class="footer-note">
            <p><strong>Note importante :</strong> Ce testament doit être complété selon les règles de l'héritage islamique (Mirath). 
            Il est recommandé de consulter un spécialiste en droit islamique pour s'assurer de la conformité avec les lois locales.</p>
            <p>Les dispositions de ce testament ne peuvent concerner que le tiers (1/3) des biens, les deux tiers restants étant distribués selon les règles coraniques d'héritage.</p>
        </div>
    </div>

    <div class="save-indicator" id="saveIndicator">Sauvegarde effectuée</div>

    <!-- Intégration de jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
        // [TOUT LE CODE JAVASCRIPT EXISTANT EST CONSERVÉ ICI]
        // Variables globales
        let etapeActuelle = 1;
        const totalEtapes = 5;

        // Initialisation des indicateurs d'étape
        function initialiserIndicateursEtape() {
            // ... (code existant)
        }

        // Fonction pour valider une étape
        function validerEtape(etape) {
            // ... (code existant)
        }

        // Fonction pour afficher/masquer le champ conjoint
        function toggleConjointField() {
            // ... (code existant)
        }

        // Fonction pour changer d'étape
        function changerEtape(etape) {
            // ... (code existant)
        }

        // Fonction pour passer à l'étape suivante
        function nextStep() {
            // ... (code existant)
        }

        // Fonction pour revenir à l'étape précédente
        function prevStep() {
            // ... (code existant)
        }

        // Fonction pour ouvrir/fermer les catégories de famille
        function toggleCategory(categoryId) {
            // ... (code existant)
        }

        // Fonction pour ajouter une personne à une catégorie
        function addPerson(category) {
            // ... (code existant)
        }

        // Fonction pour ajouter un bien/actif
        function addAsset(category) {
            // ... (code existant)
        }

        // Fonction pour ajouter une créance ou dette (étape 4)
        function addDebt(category) {
            // ... (code existant)
        }

        // Fonction pour ajouter une sadaqa (étape 4)
        function addSadaqa() {
            // ... (code existant)
        }

        // Fonction pour ajouter un réseau social (étape 5)
        function addReseauSocial() {
            // ... (code existant)
        }

        // Fonction pour ajouter un compte email (étape 5)
        function addEmail() {
            // ... (code existant)
        }

        // Fonction pour ajouter un compte en ligne (étape 5)
        function addCompteOnline() {
            // ... (code existant)
        }

        // Fonction pour ajouter un service cloud (étape 5)
        function addCloud() {
            // ... (code existant)
        }

        // Fonction pour ajouter un appareil (étape 5)
        function addAppareil() {
            // ... (code existant)
        }

        // Fonction pour calculer la Zakat
        function calculerZakat() {
            // ... (code existant)
        }

        function sauvegarderBrouillon() {
            // ... (code existant)
        }

        function genererPDF() {
            // ... (code existant)
        }

        function partagerWhatsApp() {
            // ... (code existant)
        }

        function partagerFacebook() {
            // ... (code existant)
        }

        function partagerTwitter() {
            // ... (code existant)
        }

        function partagerEmail() {
            // ... (code existant)
        }

        // Initialiser l'application
        window.addEventListener('load', function() {
            // ... (code existant)
        });

        // Code pour la génération du PDF avec jsPDF
        document.getElementById('generatePdfBtn').addEventListener('click', function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
            let y = 40;

            // Récupérer toutes les données du formulaire
            let formData = {};
            let elements = document.querySelectorAll('#testamentForm [name]');
            elements.forEach(el => {
                if (el.type === 'checkbox' || el.type === 'radio') {
                    if (!formData[el.name]) formData[el.name] = [];
                    if (el.checked) formData[el.name].push(el.value);
                } else {
                    formData[el.name] = el.value;
                }
            });

            // Récupérer les sections dynamiques (famille, biens, etc.)
            function getSectionData(containerId) {
                let data = [];
                const items = document.querySelectorAll(`#${containerId} .person-entry, #${containerId} .asset-entry, #${containerId} .debt-entry`);
                items.forEach(entry => {
                    let itemData = {};
                    entry.querySelectorAll('[name]').forEach(input => {
                        itemData[input.name] = input.value;
                    });
                    data.push(itemData);
                });
                return data;
            }

            const dynSections = [
                {container: 'parents-container', label: 'Parents'},
                {container: 'conjoints-container', label: 'Conjoints'},
                {container: 'freres-soeurs-container', label: 'Frères et Sœurs'},
                {container: 'enfants-container', label: 'Enfants'},
                {container: 'amis-container', label: 'Amis'},
                {container: 'immobilier-container', label: 'Biens immobiliers'},
                {container: 'materiel-container', label: 'Biens matériels'},
                {container: 'personnels-container', label: 'Biens personnels'},
                {container: 'comptes-container', label: 'Comptes bancaires'},
                {container: 'cartes-container', label: 'Cartes bancaires'},
                {container: 'applications-container', label: 'Applications bancaires'},
                {container: 'creances-container', label: 'Créances à percevoir'},
                {container: 'dettes-container', label: 'Dettes à régler'}
            ];

            dynSections.forEach(section => {
                formData[section.label] = getSectionData(section.container);
            });

            // Générer le PDF : titre, texte, mise en forme simple
            doc.setFont('Helvetica', 'bold');
            doc.setFontSize(24);
            doc.text('Al Wassiya - Testament Islamique', 40, y);
            y += 30;
            doc.setFontSize(14);
            doc.setTextColor(70, 90, 110);
            doc.text("Résumé complet du formulaire :", 40, y);
            y += 20;
            doc.setFont('Helvetica', 'normal');
            doc.setTextColor(30, 30, 40);

            Object.keys(formData).forEach(key => {
                if(Array.isArray(formData[key]) && formData[key].length > 0) {
                    doc.setFont('Helvetica', 'bold');
                    doc.text(key, 40, y);
                    y += 18;
                    doc.setFont('Helvetica', 'normal');
                    formData[key].forEach(item => {
                        let line = Object.entries(item).map(([k, v]) => `${k}: ${v}`).join(' | ');
                        doc.text(line, 50, y);
                        y += 14;
                    });
                    y += 10;
                } else if (formData[key]) {
                    let lineTxt = `${key}: ${formData[key]}`;
                    doc.text(lineTxt, 40, y);
                    y += 14;
                }
            });

            doc.setTextColor(168, 146, 98);
            doc.setFontSize(10);
            doc.text('Document généré automatiquement - Al Wassiya', 40, 780);

            doc.save('testament_wassiya.pdf');
        });
    </script>
</body>
</html>
